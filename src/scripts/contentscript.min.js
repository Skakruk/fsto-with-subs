var subsVideoPlayer=(function(){return{playerEl:null,subtitleSelected:false,currentFileData:{},enTitle:"",subtitles:[],videoIndex:0,playlist:[],params:{osUrl:"http://www.opensubtitles.org",shift:0},subtitlesControlTemplate:'<div class="b-player-page-controls__subtitles-wrap">            <div class="b-player-page-controls__item m-subtitles">                <div class="b-player-page-controls__item-selected">                    <span class="b-player-page-controls__item-selected-inner">                        <span class="subtitles-title">CC</span>                    </span>                </div>                <div class="b-player-page-controls__item-dropdown" style="display: none;">                    <ul class="subtitles-list"></ul>                    <label class="addSubtitle">+<input type="file" id="uploadSrt"/></label>                    <div class="shift-wrap">                        <input type="range" class="shiftSlider" min="-20" max="20" step="0.2">                        <div class="shiftShow" />                    </div>                    <div class="b-player-page-controls__item-dropdown-hide"><span>Свернуть</span></div>                </div>            </div>        </div>        ',template:'<div class="custom_video">                <video preload="auto" autobuffer controls id="pl_container"></video>            </div>',injectScript:function(a){var b=document.createElement("script");
b.src=chrome.extension.getURL(a);b.onload=function(){this.parentNode.removeChild(this);};(document.head||document.documentElement).appendChild(b);},injectCss:function(a){var b=document.createElement("link");
b.href=chrome.extension.getURL(a);b.rel="stylesheet";(document.head||document.documentElement).appendChild(b);},getPlayer:function(){this.oldPlayer=$(".l-content-player-player");
return this.oldPlayer;},removeOldPlayer:function(){this.getPlayer().remove();},insertNewPlayer:function(){var b=this.getPlayer();var c=b.css("width");var a=b.css("height");
$(".l-content-player-player").css("height","+=25px").html(this.template);this.playerEl=$("#pl_container").css({height:a,width:c});this.player=Popcorn("#pl_container");
return this.player;},requestZip:function(a){return $.ajax({url:a,encoding:null,type:"GET",contentType:"application/zip",mimeType:"text/plain; charset=x-user-defined"});
},feedSubtitles:function(){var a=this;$("#subs_holder").empty();parseSRT({text:a.subtitlesData}).data.forEach(function(b){b.subtitle.start+=a.params.shift;
b.subtitle.end+=a.params.shift;a.player.subtitle(b.subtitle);});},showShiftValue:function(){var a=this;$(".shiftShow, .leftGrip").text((a.params.shift>0?"+":"")+a.params.shift.toFixed(1));
$(".leftGrip").css("marginLeft","-"+parseInt($(".leftGrip").css("width"))/2+"px");},osAPI:{options:{url:"http://api.opensubtitles.org/xml-rpc",token:localStorage.getItem("ostoken")},login:function(){var a=this;
if(!a.options.token){return $.xmlrpc({url:a.options.url,methodName:"LogIn",params:["","","","OSTestUserAgent"],success:function(d,c,e){if(d[0].status==="200 OK"){a.options.token=d[0].token;
localStorage.setItem("ostoken",a.options.token);}},error:function(e,c,d){console.log(arguments);}});}else{var b=$.Deferred();b.resolve();return b.promise();
}},search:function(f,b,a,d){var c=this;return $.xmlrpc({url:c.options.url,methodName:"SearchSubtitles",params:[c.options.token,[{sublanguageid:"eng",query:f+" "+b+" s"+a+"e"+d}]],success:function(g,e,h){console.log(arguments);
}});},download:function(a){var b=this;return $.xmlrpc({url:b.options.url,methodName:"DownloadSubtitles",params:[b.options.token,a]});},decode:function(c){var e=atob(c);
var b=e.split("").map(function(f){return f.charCodeAt(0);});var a=new Uint8Array(b);var d=pako.inflate(a);return String.fromCharCode.apply(null,new Uint16Array(d));
}},fetchSubs:function(){var e=this,c=[],f=new $.Deferred();var a=$(".b-player-skin__year a:first-child span").text();e.subtitles={};var b=$(".b-player-page-controls__folder-content-wrap:visible");
b.find(".b-player-page-controls__subtitles-wrap").remove();b.append($(e.subtitlesControlTemplate));var d=$(".b-player-page-controls__subtitles-wrap");e.osAPI.login().then(function(){e.osAPI.search(e.enTitle,a,e.currentFileData.fsData.file_season,e.currentFileData.fsData.file_series).then(function(g){if(g[0].data){var h=[],i=[];
g[0].data.forEach(function(j){if(j.SubHearingImpaired=="0"&&i.indexOf(j.MovieReleaseName.trim().toLowerCase())===-1){h.push(j.IDSubtitleFile);e.subtitles[j.IDSubtitleFile]={name:j.MovieReleaseName};
i.push(j.MovieReleaseName.trim().toLowerCase());}});e.osAPI.download(h).then(function(j){if(j[0].data){j[0].data.forEach(function(k){e.subtitles[k.idsubtitlefile].data=e.osAPI.decode(k.data);
});f.resolve();}});}});});f.then(function(){$(".subtitles-list").empty();Object.keys(e.subtitles).forEach(function(h){var i=e.subtitles[h];var g=$('<li class="b-player-page-controls__item-dropdown-item">'+i.name+"</li>");
$(".subtitles-list").append(g);g.data("srt",i.data);});$(".subtitles-list li").on("click",function(){$(".subtitles-list li").removeClass("selected");var g=$(this);
g.addClass("selected");e.params.shift=0;if(g.data("srt")){e.subtitlesData=g.data("srt");e.feedSubtitles();e.subtitleSelected=true;$(".shift-wrap").show();
}else{e.subtitleSelected=false;$(".shift-wrap").hide();}});if(e.subtitleSelected){$(".subtitles-list li:first-child").trigger("click");}});},_getUrlVars:function(){var d=[],c;
var a=window.location.href.slice(window.location.href.indexOf("?")+1).split("&");for(var b=0;b<a.length;b++){c=a[b].split("=");d.push(c[0]);d[c[0]]=c[1];
}return d;},loadVideo:function(){var a=this;a.playerEl.attr("src",a.currentFileData.videoUrl);},startShow:function(){var a=this;if($(".l-content-player-skin").is(":visible")){$(".b-player-skin-play").show();
}else{a.player.play();}},replacePlayer:function(a){var b=this;b.insertNewPlayer();$("#uploadSrt").on("change",function(){var c=new FileReader();c.readAsText(this.files[0],"UTF-8");
c.onload=function(d){b.subtitlesData=d.target.result;b.feedSubtitles();};});b.playerEl.prop("volume",localStorage.getItem("fs.volume")||0.5);$(document).on("keydown",function(c){if(c.keyCode===32){if(player.paused()){b.player.play();
}else{b.player.pause();}}});b.playerEl.on("click",function(){if(b.player.paused()){b.player.play();}else{b.player.pause();}});b.enTitle=$(".b-player-skin__header-origin").text();
b.player.on("ended",function(){b.videoIndex+=1;if(b.videoIndex!==b.playlist.length){b.currentFileData=b.playlist[b.videoIndex];b.loadVideo();b.params.shift=0;
}});b.player.on("playing",function(){});b.player.on("volumechange",function(){localStorage.setItem("fs.volume",b.playerEl.prop("volume"));});$("#episode").on("change",function(){b.fetchSubs();
});b.showShiftValue();$(".shiftSlider").on("change",function(){if(b.subtitlesData){b.params.shift=parseInt(this.value);b.showShiftValue();}else{$(".shift-wrap").hide();
}});$(".b-player-skin-play").on("click",function(){b.player.play();});}};});var videoPlayer=new subsVideoPlayer();["scripts/inject.js"].forEach(function(a){videoPlayer.injectScript(a);
});var observer=new MutationObserver(function(a){a.forEach(function(b){if(b.attributeName==="currentfile"){videoPlayer.currentFileData=JSON.parse($("body").attr("currentfile"));
videoPlayer.loadVideo();videoPlayer.fetchSubs();videoPlayer.startShow();}});});observer.observe(document.querySelector("body"),{attributes:true});videoPlayer.replacePlayer();
